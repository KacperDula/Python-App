{% extends 'base.html' %}

{% block content %}
<div class="chat-container">
  <div class="sidebar">
    <div class="info-box">
      <h4>Room Information</h4>
      <div class="info-content">
        <p>Room Code: <span class="room-code">{{code}}</span></p>
      </div>
    </div>
    
    <div class="info-box">
      <h4>Users Online</h4>
      <div class="info-content">
        <p>Total: <span class="user-count" id="user-count">1</span></p>
        <ul class="user-list" id="user-list">
          <li>{{name}} (You)</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="chat-area">
    <div class="message-box" id="messages">
      {% for msg in messages %}
      <div class="message">
        <div class="message-header">
          <span class="message-sender">{{msg.name}}</span>
          <span class="message-time">{{msg.time}}</span>
        </div>
        <div class="message-content">
          {% if msg.is_file %}
            {% if msg.message.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
              <a href="{{msg.message}}" target="_blank">
                <img src="{{msg.message}}" class="uploaded-image" alt="Uploaded image">
              </a>
            {% else %}
              <a href="{{msg.message}}" download>Download file</a>
            {% endif %}
          {% else %}
            {{msg.message}}
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    
    <div class="input-area">
      <div class="message-input">
        <input type="text" id="message" placeholder="Type your message..."
          onkeydown="handleKeyDown(event)">
        <label for="file-upload" class="file-upload-label">
          ðŸ“Ž
          <input type="file" id="file-upload" accept="image/*, .pdf, .doc, .docx, .txt" style="display:none">
        </label>
        <button id="send-btn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var socketio = io();
  const messageInput = document.getElementById("message");

  const sendMessage = () => {
    const message = messageInput.value.trim();
    if (message === "") return;
    
    socketio.emit("message", { data: message });
    messageInput.value = "";
    messageInput.focus();
  };

  const handleKeyDown = (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      sendMessage();
    }
  };

  document.getElementById('file-upload').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
      alert('File size too large (max 5MB)');
      return;
    }

    const formData =
